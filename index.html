<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PUYOLA Online Platform</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<style>
body{margin:0;font-family:Arial,sans-serif;background:#f4f4f4;color:#333}
header{background:#003366;color:#fff;padding:15px;text-align:center;position:relative}
header img{height:70px}
.logout-btn{position:absolute;right:15px;top:15px;background:#ff4d4d;color:white;padding:5px 10px;border-radius:4px;font-size:0.8em;border:none;cursor:pointer}
section{padding:20px; max-width: 900px; margin: auto;}
.card{background:#fff;padding:15px;margin:10px 0;border-radius:6px;box-shadow: 0 2px 4px rgba(0,0,0,0.1)}
.hidden{display:none}
input,textarea,select{width:100%;padding:10px;margin:8px 0;border:1px solid #ccc;border-radius:4px;box-sizing: border-box;}
button{background:#003366;color:#fff;border:none;padding:10px 15px;margin:5px 0;border-radius:4px;cursor:pointer;font-weight:bold}
button:hover{opacity:0.9}
footer{text-align:center;background:#eee;padding:20px;margin-top:20px}
table{width:100%;border-collapse:collapse;margin-top:10px;background:#fff}
th,td{border:1px solid #ddd;padding:8px;text-align:left;font-size:0.8em}
th{background:#003366;color:#fff}
.btn-edit{background:#ffc107; color: #000; padding: 4px 8px; margin-right: 5px; border-radius:4px;}
.btn-del{background:#dc3545; color: #fff; padding: 4px 8px; border-radius:4px;}
.tabs{display:flex; gap:10px; margin-bottom:10px;}
.tab-btn{background:#ccc; color:#333; flex:1}
.tab-btn.active{background:#003366; color:white}
.badge{background:#28a745; color:white; padding:2px 8px; border-radius:10px; font-size:0.8em; margin-left:10px}
.poll-res{background:#eef; padding:8px; margin:4px 0; border-radius:4px; border-left:4px solid #003366; font-size:0.9em}
.timer{color:#dc3545; font-weight:bold; font-size:0.85em}
.toggle-btn{background:#6c757d; font-size:0.8em; margin-bottom:10px; width:100%}
.contact-grid{display: flex; gap: 10px; margin-top: 10px;}
.btn-email{background:#ea4335; flex:1; text-align:center; display:block; text-decoration:none; color:white; padding:10px; border-radius:4px;}
.btn-whatsapp{background:#25d366; flex:1; text-align:center; display:block; text-decoration:none; color:white; padding:10px; border-radius:4px;}
</style>
</head>

<body>

<div id="loginBox" class="card" style="max-width:400px;margin:80px auto;text-align:center">
  <img src="logo.png" alt="PUYOLA Logo" style="width:100px; margin-bottom:10px;">
  <h2>PUYOLA</h2>
  <input type="password" id="loginPassword" placeholder="Enter password">
  <label style="font-size:0.9em"><input type="checkbox" id="togglePass"> Show Password</label><br>
  <button id="loginBtn" style="width:100%;margin-top:10px">Login</button>
</div>

<section id="adminView" class="hidden">
<header>Admin Dashboard <button class="logout-btn" onclick="window.logout()">Logout</button></header>

<div class="card">
    <div class="tabs">
        <button class="tab-btn active" id="tabRegister" onclick="window.switchTab('reg')">Members <span id="regCount" class="badge">0</span></button>
        <button class="tab-btn" id="tabAttend" onclick="window.switchTab('att')">Attendance</button>
    </div>

    <div id="editZone" class="hidden" style="background:#fff9e6; padding:10px; border-radius:5px; border:1px solid #ffeeba; margin-bottom:10px;">
        <strong>Editing Record:</strong>
        <input id="editName" placeholder="Name">
        <input id="editAdm" placeholder="Admission">
        <button id="saveEditBtn" style="background:#28a745">Update</button>
        <button onclick="document.getElementById('editZone').classList.add('hidden')" style="background:#6c757d">Cancel</button>
    </div>

    <div id="regSection">
        <button class="toggle-btn" onclick="window.toggleTable('memberTableWrapper')">Show/Hide Member List</button>
        <div id="memberTableWrapper" class="hidden">
            <input type="text" placeholder="Search members..." oninput="window.filterTable('adminMembers', this.value)">
            <button id="exportMembersBtn" style="background: #28a745">Export Members (CSV)</button>
            <div style="overflow-x:auto;"><table><thead><tr><th>Name</th><th>Adm</th><th>Year</th><th>Phone</th><th>Joined</th><th>Action</th></tr></thead><tbody id="adminMembers"></tbody></table></div>
        </div>
    </div>

    <div id="attSection" class="hidden">
        <button class="toggle-btn" onclick="window.toggleTable('attendTableWrapper')">Show/Hide Attendance List</button>
        <div id="attendTableWrapper" class="hidden">
            <input type="text" placeholder="Search attendance..." oninput="window.filterTable('adminAttendance', this.value)">
            <button id="exportAttendanceBtn" style="background: #28a745">Export Attendance (CSV)</button>
            <div style="overflow-x:auto;"><table><thead><tr><th>Name</th><th>Adm</th><th>Event</th><th>Time</th><th>Action</th></tr></thead><tbody id="adminAttendance"></tbody></table></div>
        </div>
    </div>
</div>

<div class="card">
    <button onclick="document.getElementById('formArea').classList.toggle('hidden')" style="width:100%">Open Creation Tools</button>
    <div id="formArea" class="hidden">
        <h4>Create New Poll</h4>
        <input id="pTitle" placeholder="Poll Question">
        <input id="pOptions" placeholder="Options (comma separated)">
        <input type="number" id="pDuration" placeholder="Duration (Minutes)">
        <button id="startPoll">Start Poll</button>
        <hr>
        <h4>Events & Announcements</h4>
        <input id="aTitle" placeholder="Announcement Title"><textarea id="aBody" placeholder="Message Body"></textarea>
        <button id="postAnnouncement">Post Announcement</button>
        <hr>
        <input id="eTitle" placeholder="Event Name">
        <input type="date" id="eDate">
        <input type="time" id="eTime">
        <input id="eVenue" placeholder="Venue">
        <button id="addEvent">Add Event</button>
    </div>
</div>
<div id="adminPolls"></div>
<div id="adminAnnouncements"></div>
<div id="adminEventsList"></div>
</section>

<section id="memberView" class="hidden">
<header>Member Dashboard <button class="logout-btn" onclick="window.logout()">Logout</button></header>

<div class="card">
    <h4 style="margin-top:0">Support & Feedback</h4>
    <div class="contact-grid">
        <a href="mailto:info.puyola@gmail.com" class="btn-email"><i class="fas fa-envelope"></i> Email Us</a>
        <a href="https://wa.me/254793378439" target="_blank" class="btn-whatsapp"><i class="fab fa-whatsapp"></i> Contact Admin</a>
    </div>
</div>

<div class="card">
    <h3>Join PUYOLA (Membership)</h3>
    <input id="regName" placeholder="Full Name"><input id="regAdm" placeholder="Admission No">
    <select id="regYear"><option value="">Select Year</option><option>Year 1</option><option>Year 2</option><option>Year 3</option><option>Year 4</option></select>
    <input id="regPhone" placeholder="Phone">
    <button id="submitRegistration" style="width:100%; background:#28a745">Register</button>
    <button id="updateRegistration" style="width:100%; background:#ffc107; color:black">Update (To change Existing Details)</button>
</div>
<div class="card">
    <h3>Event Attendance</h3>
    <input id="attName" placeholder="Full Name"><input id="attAdm" placeholder="Admission No"><select id="mEventSelect"><option value="">Select Event</option></select><button id="submitAttendance" style="width:100%">Sign-In</button>
</div>

<div id="memberPolls"></div>
<div id="memberAnnouncements"></div>
<div id="memberEvents"></div>
</section>

<footer>¬© <span id="year"></span> PUYOLA | Designed by Oguma Austine</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, onSnapshot, getDoc, increment, query, where } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

const firebaseConfig={
  apiKey:"AIzaSyD4CHTW2lrpUzSnvX3KGJrIPSjdaoqoBQE",
  authDomain:"puyola-platform.firebaseapp.com",
  projectId:"puyola-platform",
  storageBucket:"puyola-platform.firebasestorage.app",
  messagingSenderId:"831659964215",
  appId:"1:831659964215:web:6d568b43f4ad7f09af4cb2"
};
const app=initializeApp(firebaseConfig);
const db=getFirestore(app);

const ADMIN="Puyola@0032542025", MEMBER="Puyola@2025";
let currentEditId=null, currentEditCol="";

window.onload=()=>{
    const s=localStorage.getItem("puyola_session");
    if(s==="admin"){ loginBox.classList.add("hidden"); adminView.classList.remove("hidden"); loadAll(); }
    else if(s==="member"){ loginBox.classList.add("hidden"); memberView.classList.remove("hidden"); loadAll(); }
};

document.getElementById("loginBtn").onclick=()=>{
  const p=document.getElementById("loginPassword").value;
  if(p===ADMIN){ localStorage.setItem("puyola_session","admin"); location.reload(); }
  else if(p===MEMBER){ localStorage.setItem("puyola_session","member"); location.reload(); }
  else alert("Wrong password");
};

window.logout=()=>{ localStorage.removeItem("puyola_session"); location.reload(); };
document.getElementById("togglePass").onchange=e=>{ document.getElementById("loginPassword").type=e.target.checked?"text":"password"; };

function getTimerText(expiry){
    const now = new Date().getTime();
    const diff = expiry - now;
    if(diff <= 0) return "Expired";
    const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    const secs = Math.floor((diff % (1000 * 60)) / 1000);
    return `${mins}m ${secs}s remaining`;
}

/* ADMIN POSTING ACTIONS */
document.getElementById("startPoll").onclick=async()=>{
  const opts = document.getElementById("pOptions").value.split(",").map(o=>o.trim());
  let votes = {}; opts.forEach(o=>votes[o]=0);
  const durationMs = (parseInt(document.getElementById("pDuration").value) || 60) * 60000;
  await addDoc(collection(db,"polls"), { title: pTitle.value, options: opts, votes: votes, expiry: new Date().getTime() + durationMs });
  alert("Poll Started!"); 
  pTitle.value=""; pOptions.value=""; pDuration.value="";
};

document.getElementById("postAnnouncement").onclick=async()=>{
  await addDoc(collection(db,"announcements"), { title: aTitle.value, body: aBody.value });
  alert("Announcement Posted!"); aTitle.value=""; aBody.value="";
};

document.getElementById("addEvent").onclick=async()=>{
  await addDoc(collection(db,"events"), { title: eTitle.value, date: eDate.value, time: eTime.value, venue: eVenue.value });
  alert("Event Added!"); 
  eTitle.value=""; eDate.value=""; eTime.value=""; eVenue.value="";
};

window.vote=async(id,opt)=>{
  await updateDoc(doc(db,"polls",id), { [`votes.${opt}`]: increment(1) });
  localStorage.setItem("voted_"+id, true);
};

window.switchTab=t=>{
    document.getElementById("regSection").classList.toggle("hidden", t!=='reg');
    document.getElementById("attSection").classList.toggle("hidden", t!=='att');
    document.getElementById("tabRegister").classList.toggle("active", t==='reg');
    document.getElementById("tabAttend").classList.toggle("active", t==='att');
};

window.toggleTable=(id)=>{ document.getElementById(id).classList.toggle("hidden"); };

window.filterTable=(tid,v)=>{
    const rows=document.getElementById(tid).getElementsByTagName("tr");
    for(let r of rows){ r.style.display=r.innerText.toLowerCase().includes(v.toLowerCase())?"":"none"; }
};

window.prepareEdit=async(col,id)=>{
    const snap=await getDoc(doc(db,col,id));
    if(snap.exists()){
        currentEditId=id; currentEditCol=col;
        document.getElementById("editName").value=snap.data().name;
        document.getElementById("editAdm").value=snap.data().adm;
        document.getElementById("editZone").classList.remove("hidden");
        window.scrollTo(0,0);
    }
};

document.getElementById("saveEditBtn").onclick=async()=>{
    await updateDoc(doc(db,currentEditCol,currentEditId), {name:editName.value, adm:editAdm.value});
    document.getElementById("editZone").classList.add("hidden");
    alert("Updated!");
};

function loadAll(){ loadAdminData(); loadAnnouncements(); loadEvents(); loadPolls(); }

function loadAdminData(){
    onSnapshot(collection(db,"members"),s=>{
        adminMembers.innerHTML=""; regCount.innerText=s.size;
        s.forEach(d=>{ const x=d.data(); adminMembers.innerHTML+=`<tr><td>${x.name}</td><td>${x.adm}</td><td>${x.year}</td><td>${x.phone}</td><td>${x.date}</td><td><button class="btn-edit" onclick="window.prepareEdit('members','${d.id}')">Edit</button><button class="btn-del" onclick="window.delItem('members','${d.id}')">Del</button></td></tr>`; });
    });
    onSnapshot(collection(db,"attendance"),s=>{
        adminAttendance.innerHTML="";
        s.forEach(d=>{ const x=d.data(); adminAttendance.innerHTML+=`<tr><td>${x.name}</td><td>${x.adm}</td><td>${x.event}</td><td>${x.time}</td><td><button class="btn-edit" onclick="window.prepareEdit('attendance','${d.id}')">Edit</button><button class="btn-del" onclick="window.delItem('attendance','${d.id}')">Del</button></td></tr>`; });
    });
}

function loadPolls(){
    onSnapshot(collection(db,"polls"),s=>{
        adminPolls.innerHTML="<h4>Manage Polls</h4>"; memberPolls.innerHTML="<h3>Active Polls</h3>";
        s.forEach(d=>{
            const p=d.data(); const isExpired = new Date().getTime() > p.expiry;
            let resHtml=""; for(let o in p.votes){ resHtml+=`<div class="poll-res">${o}: <b>${p.votes[o]}</b></div>`; }
            adminPolls.innerHTML+=`<div class="card"><b>${p.title}</b><br><span class="timer" id="timer-admin-${d.id}"></span>${resHtml}<button class="btn-del" onclick="window.delItem('polls','${d.id}')">Remove Poll</button></div>`;
            let mVoteHtml=`<div class="card"><b>${p.title}</b><br><span class="timer" id="timer-member-${d.id}"></span><br>`;
            if(localStorage.getItem("voted_"+d.id) || isExpired){ mVoteHtml+=`<small>Results:</small>${resHtml}`; } 
            else { p.options.forEach(o=>{ mVoteHtml+=`<button onclick="window.vote('${d.id}','${o}')">${o}</button> `; }); }
            memberPolls.innerHTML+=mVoteHtml+"</div>";
            setInterval(()=>{
                const t = getTimerText(p.expiry);
                if(document.getElementById(`timer-admin-${d.id}`)) document.getElementById(`timer-admin-${d.id}`).innerText = t;
                if(document.getElementById(`timer-member-${d.id}`)) document.getElementById(`timer-member-${d.id}`).innerText = t;
            }, 1000);
        });
    });
}

function loadAnnouncements(){
    onSnapshot(collection(db,"announcements"),s=>{
      adminAnnouncements.innerHTML="<h4>Announcements</h4>"; memberAnnouncements.innerHTML="<h3>Announcements</h3>";
      s.forEach(d=>{ const x=d.data(); const h=`<div class="card"><b>${x.title}</b><p>${x.body}</p><button class="btn-del" onclick="window.delItem('announcements','${d.id}')">Delete Post</button></div>`; adminAnnouncements.innerHTML+=h; memberAnnouncements.innerHTML+=h; });
    });
}

function loadEvents(){
    onSnapshot(collection(db,"events"), s=>{
      memberEvents.innerHTML="<h3>Events</h3>"; 
      adminEventsList.innerHTML="<h4>Manage Events</h4>"; 
      mEventSelect.innerHTML='<option value="">Select Event</option>';
      s.forEach(d=>{ 
          const x=d.data(); 
          const eventHtml = `<div class="card"><b>${x.title}</b><br>üìÖ ${x.date} | üïí ${x.time}<br>üìç ${x.venue}</div>`;
          memberEvents.innerHTML += eventHtml;
          adminEventsList.innerHTML += `<div class="card"><b>${x.title}</b><br><button class="btn-del" onclick="window.delItem('events','${d.id}')">Delete Event</button></div>`;
          mEventSelect.innerHTML += `<option value="${x.title}">${x.title}</option>`; 
      });
    });
}

document.getElementById("submitRegistration").onclick=async()=>{
  const n = regName.value.trim(), a = regAdm.value.trim();
  if(!n || !a) return alert("Fill Name and Adm No.");
  const snap = await getDocs(collection(db, "members"));
  let duplicate = false;
  snap.forEach(d => { if(d.data().name.toLowerCase() === n.toLowerCase() && d.data().adm.toLowerCase() === a.toLowerCase()) duplicate = true; });
  if(duplicate) return alert("Details Exist! Update Instead.");
  await addDoc(collection(db,"members"),{name:n, adm:a, year:regYear.value, phone:regPhone.value, date:new Date().toLocaleString()});
  alert("Registered!"); regName.value=""; regAdm.value=""; regPhone.value="";
};

document.getElementById("updateRegistration").onclick=async()=>{
  const n = regName.value.trim(), a = regAdm.value.trim();
  if(!n || !a) return alert("Enter Name and Adm No.");
  const snap = await getDocs(collection(db, "members"));
  let fId = null;
  snap.forEach(d => { if(d.data().name.toLowerCase() === n.toLowerCase() && d.data().adm.toLowerCase() === a.toLowerCase()) fId = d.id; });
  if(fId){
      await updateDoc(doc(db, "members", fId), { year: regYear.value, phone: regPhone.value, date: "Updated: " + new Date().toLocaleString() });
      alert("Updated!"); regName.value=""; regAdm.value=""; regPhone.value="";
  } else alert("Not found!");
};

document.getElementById("submitAttendance").onclick=async()=>{
  await addDoc(collection(db,"attendance"),{name:attName.value, adm:attAdm.value, event:mEventSelect.value, time:new Date().toLocaleString()});
  alert("Attendance Recorded!"); attName.value=""; attAdm.value="";
};

document.getElementById("exportMembersBtn").onclick=async()=>{
  const s=await getDocs(collection(db,"members"));
  let csv="Name,Adm,Year,Phone,Date\n";
  s.forEach(d=>{ const x=d.data(); csv+=`"${x.name}","${x.adm}","${x.year}","${x.phone}","${x.date}"\n`; });
  const b=new Blob([csv],{type:'text/csv'}); const l=document.createElement("a"); l.href=URL.createObjectURL(b); l.download="PUYOLA_Members.csv"; l.click();
};

window.delItem=async(c,i)=>{ if(confirm("Confirm deletion?")) await deleteDoc(doc(db,c,i)); };
document.getElementById("year").textContent=new Date().getFullYear();
</script>
</body>
</html>
