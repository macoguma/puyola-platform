<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PUYOLA Online Platform</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<style>
body{margin:0;font-family:Arial,sans-serif;background:#f4f4f4;color:#333}
header{background:#003366;color:#fff;padding:15px;text-align:center;position:relative}
header img{height:70px}
.logout-btn{position:absolute;right:15px;top:15px;background:#ff4d4d;color:white;padding:5px 10px;border-radius:4px;font-size:0.8em;border:none;cursor:pointer}
section{padding:20px; max-width: 900px; margin: auto;}
.card{background:#fff;padding:15px;margin:10px 0;border-radius:6px;box-shadow: 0 2px 4px rgba(0,0,0,0.1)}
.hidden{display:none}
input,textarea,select{width:100%;padding:10px;margin:8px 0;border:1px solid #ccc;border-radius:4px;box-sizing: border-box;}
button{background:#003366;color:#fff;border:none;padding:10px 15px;margin:5px 0;border-radius:4px;cursor:pointer;font-weight:bold}
button:hover{opacity:0.9}
footer{text-align:center;background:#eee;padding:20px;margin-top:20px;font-size:0.8em;color:#555}
table{width:100%;border-collapse:collapse;margin-top:10px;background:#fff}
th,td{border:1px solid #ddd;padding:8px;text-align:left;font-size:0.8em}
th{background:#003366;color:#fff}
.btn-edit{background:#ffc107; color: #000; padding: 4px 8px; margin-right: 5px; border-radius:4px;}
.btn-del{background:#dc3545; color: #fff; padding: 4px 8px; border-radius:4px;}
.tabs{display:flex; gap:10px; margin-bottom:10px;}
.tab-btn{background:#ccc; color:#333; flex:1}
.tab-btn.active{background:#003366; color:white}
.badge{background:#28a745; color:white; padding:2px 8px; border-radius:10px; font-size:0.8em; margin-left:10px}
.poll-res{background:#eef; padding:8px; margin:4px 0; border-radius:4px; border-left:4px solid #003366; font-size:0.9em}
.timer{color:#dc3545; font-weight:bold; font-size:0.85em}
.toggle-btn{background:#6c757d; font-size:0.8em; margin-bottom:10px; width:100%}
.contact-grid{display: flex; gap: 10px; margin-top: 10px;}
.btn-email{background:#ea4335; flex:1; text-align:center; display:block; text-decoration:none; color:white; padding:10px; border-radius:4px;}
.btn-whatsapp{background:#25d366; flex:1; text-align:center; display:block; text-decoration:none; color:white; padding:10px; border-radius:4px;}
.anon-msg{background:#fff5f5; border-left: 5px solid #ff4d4d; padding: 10px; margin: 5px 0; font-style: italic;}
.status-indicator{font-size:0.8em; font-weight:bold; padding:4px 8px; border-radius:12px;}
.status-open{background:#d4edda; color:#155724;}
.status-closed{background:#f8d7da; color:#721c24;}
</style>
</head>

<body>

<div id="loginBox" class="card" style="max-width:400px;margin:80px auto;text-align:center">
  <img src="logo.png" alt="PUYOLA Logo" style="width:100px; margin-bottom:10px;">
  <h2>PUYOLA</h2>
  <input type="password" id="loginPassword" placeholder="Enter password">
  <label style="font-size:0.9em"><input type="checkbox" id="togglePass"> Show Password</label><br>
  <button id="loginBtn" style="width:100%;margin-top:10px">Login</button>
</div>

<section id="adminView" class="hidden">
<header>Admin Dashboard <button class="logout-btn" onclick="window.logout()">Logout</button></header>
<div class="card">
    <div class="tabs">
        <button class="tab-btn active" onclick="window.switchTab('reg')">Members <span id="regCount" class="badge">0</span></button>
        <button class="tab-btn" onclick="window.switchTab('att')">Attendance</button>
        <button class="tab-btn" onclick="window.switchTab('anon')">Feedback</button>
    </div>
    
    <div id="attSection" class="hidden">
        <div style="background:#eef; padding:10px; border-radius:5px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
            <span><strong>Meeting Mode:</strong> <span id="modeText">Loading...</span></span>
            <button id="toggleMeetingMode" style="background:#003366; font-size:0.7em;">Toggle Open/Close</button>
        </div>
        <button class="toggle-btn" onclick="window.toggleTable('attendTableWrapper')">Show/Hide Attendance List</button>
        <div id="attendTableWrapper" class="hidden">
            <input type="text" placeholder="Search attendance..." oninput="window.filterTable('adminAttendance', this.value)">
            <button id="exportAttendanceBtn" style="background: #28a745">Export CSV</button>
            <div style="overflow-x:auto;"><table><thead><tr><th>Name</th><th>Adm</th><th>Event</th><th>Time</th><th>Action</th></tr></thead><tbody id="adminAttendance"></tbody></table></div>
        </div>
    </div>

    <div id="regSection">
        <button class="toggle-btn" onclick="window.toggleTable('memberTableWrapper')">Show/Hide Member List</button>
        <div id="memberTableWrapper" class="hidden">
            <input type="text" placeholder="Search..." oninput="window.filterTable('adminMembers', this.value)">
            <button id="exportMembersBtn" style="background: #28a745">Export CSV</button>
            <div style="overflow-x:auto;"><table><thead><tr><th>Name</th><th>Adm</th><th>Year</th><th>Phone</th><th>Action</th></tr></thead><tbody id="adminMembers"></tbody></table></div>
        </div>
    </div>

    <div id="anonSection" class="hidden">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h4>Anonymous Feedback</h4>
            <button id="clearAllAnon" style="background:#dc3545; font-size:0.7em;">Clear All</button>
        </div>
        <div id="adminAnonList"></div>
    </div>
</div>

<div class="card">
    <button onclick="document.getElementById('formArea').classList.toggle('hidden')" style="width:100%">Creation Tools</button>
    <div id="formArea" class="hidden">
        <h4>Events & Announcements</h4>
        <input id="aTitle" placeholder="Announcement Title"><textarea id="aBody" placeholder="Message Body"></textarea><button id="postAnnouncement">Post Announcement</button>
        <hr>
        <input id="eTitle" placeholder="Event Name"><input type="date" id="eDate"><input type="time" id="eTime"><input id="eVenue" placeholder="Venue"><button id="addEvent">Add Event</button>
    </div>
</div>
<div id="adminPolls"></div>
<div id="adminEventsList"></div>
</section>

<section id="memberView" class="hidden">
<header>Member Dashboard <button class="logout-btn" onclick="window.logout()">Logout</button></header>

<div class="card" style="text-align:center; background: linear-gradient(to right, #003366, #00509e); color:white;">
    <p style="margin:5px 0; font-size:0.9em;">Current PUYOLA Family Size:</p>
    <h2 style="margin:0; font-size:2.5em;" id="liveMemberCount">0</h2>
</div>

<div class="card">
    <div class="contact-grid">
        <a href="mailto:info.puyola@gmail.com" class="btn-email"><i class="fas fa-envelope"></i> Email Us</a>
        <a href="https://wa.me/254793378439" target="_blank" class="btn-whatsapp"><i class="fab fa-whatsapp"></i> WhatsApp</a>
    </div>
</div>

<div id="attendanceCard" class="card">
    <h3>Event Attendance</h3>
    <div id="attendanceStatus"></div>
    <div id="attendanceFields">
        <input id="attName" placeholder="Full Name"><input id="attAdm" placeholder="Admission No"><select id="mEventSelect"><option value="">Select Event</option></select>
        <button id="submitAttendance" style="width:100%">Sign-In</button>
    </div>
</div>

<div class="card">
    <h3><i class="fas fa-user-secret"></i> Send Anonymous Message</h3>
    <textarea id="anonInput" placeholder="Suggestions..."></textarea>
    <button id="sendAnon" style="width:100%; background:#003366">Send</button>
</div>

<div class="card">
    <h3>Membership Management</h3>
    <input id="regName" placeholder="Full Name"><input id="regAdm" placeholder="Admission No"><select id="regYear"><option value="">Select Year</option><option>Year 1</option><option>Year 2</option><option>Year 3</option><option>Year 4</option></select><input id="regPhone" placeholder="Phone">
    <button id="submitRegistration" style="width:100%; background:#28a745">Register</button>
    <button id="updateRegistration" style="width:100%; background:#ffc107; color:black">Update Details</button>
</div>

<div id="memberAnnouncements"></div>
<div id="memberPolls"></div>
<div id="memberEvents"></div>
</section>

<footer>
    Copyright ¬©Ô∏è <span id="currentYear"></span> PUYOLA | Designed by Oguma Austine | All Rights Reserved
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, onSnapshot, getDoc, setDoc, increment, writeBatch } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

const firebaseConfig={
  apiKey:"AIzaSyD4CHTW2lrpUzSnvX3KGJrIPSjdaoqoBQE",
  authDomain:"puyola-platform.firebaseapp.com",
  projectId:"puyola-platform",
  storageBucket:"puyola-platform.firebasestorage.app",
  messagingSenderId:"831659964215",
  appId:"1:831659964215:web:6d568b43f4ad7f09af4cb2"
};
const app=initializeApp(firebaseConfig);
const db=getFirestore(app);

const ADMIN="Puyola@0032542025", MEMBER="Puyola@2025";
let isMeetingOpen = false;

window.onload=()=>{
    const s=localStorage.getItem("puyola_session");
    if(s==="admin"){ loginBox.classList.add("hidden"); adminView.classList.remove("hidden"); loadAll(); }
    else if(s==="member"){ loginBox.classList.add("hidden"); memberView.classList.remove("hidden"); loadAll(); }
    document.getElementById("currentYear").textContent=new Date().getFullYear();
};

document.getElementById("loginBtn").onclick=()=>{
  const p=document.getElementById("loginPassword").value;
  if(p===ADMIN){ localStorage.setItem("puyola_session","admin"); location.reload(); }
  else if(p===MEMBER){ localStorage.setItem("puyola_session","member"); location.reload(); }
  else alert("Wrong password");
};

window.logout=()=>{ localStorage.removeItem("puyola_session"); location.reload(); };

/* MEETING MODE LOGIC */
async function syncMeetingMode() {
    const docRef = doc(db, "settings", "meetingStatus");
    onSnapshot(docRef, (docSnap) => {
        if (docSnap.exists()) {
            isMeetingOpen = docSnap.data().isOpen;
            const statusText = isMeetingOpen ? "OPEN (Active Meeting)" : "CLOSED (No Meeting)";
            if(document.getElementById("modeText")) document.getElementById("modeText").innerText = statusText;
            
            // Member UI Update
            const statusDiv = document.getElementById("attendanceStatus");
            const fieldsDiv = document.getElementById("attendanceFields");
            if (statusDiv && fieldsDiv) {
                if (isMeetingOpen) {
                    statusDiv.innerHTML = `<span class="status-indicator status-open">Attendance is LIVE</span>`;
                    fieldsDiv.classList.remove("hidden");
                } else {
                    statusDiv.innerHTML = `<span class="status-indicator status-closed">Attendance is currently closed.</span>`;
                    fieldsDiv.classList.add("hidden");
                }
            }
        }
    });
}

document.getElementById("toggleMeetingMode").onclick = async () => {
    const docRef = doc(db, "settings", "meetingStatus");
    await setDoc(docRef, { isOpen: !isMeetingOpen });
};

/* DATA ACTIONS */
document.getElementById("sendAnon").onclick=async()=>{
    const msg = anonInput.value.trim();
    if(!msg) return;
    await addDoc(collection(db, "anonymous"), { text: msg, time: new Date().toLocaleString() });
    alert("Sent!"); anonInput.value = "";
};

document.getElementById("addEvent").onclick=async()=>{
  await addDoc(collection(db,"events"), { title: eTitle.value, date: eDate.value, time: eTime.value, venue: eVenue.value });
  alert("Added!");
};

document.getElementById("postAnnouncement").onclick=async()=>{
  await addDoc(collection(db,"announcements"), { title: aTitle.value, body: aBody.value });
  alert("Posted!"); aTitle.value=""; aBody.value="";
};

window.switchTab=t=>{
    document.getElementById("regSection").classList.toggle("hidden", t!=='reg');
    document.getElementById("attSection").classList.toggle("hidden", t!=='att');
    document.getElementById("anonSection").classList.toggle("hidden", t!=='anon');
};

/* LOADERS */
function loadAll(){ 
    syncMeetingMode();
    onSnapshot(collection(db,"members"),s=>{
        adminMembers.innerHTML=""; regCount.innerText=s.size;
        if(document.getElementById("liveMemberCount")) document.getElementById("liveMemberCount").innerText = s.size;
        s.forEach(d=>{ const x=d.data(); adminMembers.innerHTML+=`<tr><td>${x.name}</td><td>${x.adm}</td><td>${x.year}</td><td>${x.phone}</td><td><button class="btn-del" onclick="window.delItem('members','${d.id}')">Del</button></td></tr>`; });
    });
    onSnapshot(collection(db,"attendance"),s=>{
        adminAttendance.innerHTML="";
        s.forEach(d=>{ const x=d.data(); adminAttendance.innerHTML+=`<tr><td>${x.name}</td><td>${x.adm}</td><td>${x.event}</td><td>${x.time}</td><td><button class="btn-del" onclick="window.delItem('attendance','${d.id}')">Del</button></td></tr>`; });
    });
    onSnapshot(collection(db,"anonymous"), s => {
        adminAnonList.innerHTML = "";
        s.forEach(d => {
            const x = d.data();
            adminAnonList.innerHTML += `<div class="anon-msg">${x.text}<br><small>${x.time}</small> <button class="btn-del" style="font-size:0.6em" onclick="window.delItem('anonymous','${d.id}')">Del</button></div>`;
        });
    });
    onSnapshot(collection(db,"announcements"),s=>{
      memberAnnouncements.innerHTML="<h3>Announcements</h3>";
      s.forEach(d=>{ const x=d.data(); memberAnnouncements.innerHTML+=`<div class="card"><b>${x.title}</b><p>${x.body}</p></div>`; });
    });
    onSnapshot(collection(db,"events"), s=>{
      memberEvents.innerHTML="<h3>Upcoming Events</h3>"; mEventSelect.innerHTML='<option value="">Select Event</option>';
      s.forEach(d=>{ const x=d.data(); memberEvents.innerHTML+=`<div class="card">üìÖ ${x.date} | <b>${x.title}</b></div>`; mEventSelect.innerHTML+=`<option value="${x.title}">${x.title}</option>`; });
    });
}

document.getElementById("submitRegistration").onclick=async()=>{
  await addDoc(collection(db,"members"),{name:regName.value, adm:regAdm.value, year:regYear.value, phone:regPhone.value, date:new Date().toLocaleString()});
  alert("Registered!");
};

document.getElementById("submitAttendance").onclick=async()=>{
  if(!isMeetingOpen) return alert("Attendance is closed.");
  await addDoc(collection(db,"attendance"),{name:attName.value, adm:attAdm.value, event:mEventSelect.value, time:new Date().toLocaleString()});
  alert("Signed In!");
};

window.delItem=async(c,i)=>{ if(confirm("Delete?")) await deleteDoc(doc(db,c,i)); };
window.toggleTable=(id)=>{ document.getElementById(id).classList.toggle("hidden"); };
</script>
</body>
</html>
