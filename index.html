<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>PUYOLA Online Platform</title>

<style>
body { margin:0; font-family: Arial, sans-serif; background:#f4f4f4; }
header { background:#003366; color:#fff; padding:15px; text-align:center; }
header img { height:70px; }
section { padding:20px; }
.hidden { display:none; }
.card { background:#fff; padding:15px; margin:10px 0; border-radius:6px; }
input, textarea, select { width:100%; padding:8px; margin:5px 0; }
button { background:#003366; color:#fff; border:none; padding:7px 12px; margin:4px 0; cursor:pointer; }
button[disabled] { background:#999; cursor:not-allowed; }
footer { text-align:center; background:#eee; padding:10px; }
small { color:#555; }
</style>
</head>

<body>

<!-- LOGIN -->
<div id="login" class="card" style="max-width:400px;margin:80px auto;text-align:center;">
  <img src="logo.png">
  <h2>PUYOLA</h2>
  <p><b>Building Leaders. Building Legacy.</b></p>
  <input type="password" id="password" placeholder="Enter password">
  <label><input type="checkbox" id="show"> Show Password</label><br>
  <button onclick="login()">Login</button>
</div>

<!-- ADMIN -->
<section id="admin" class="hidden">
<header>Admin Dashboard</header>

<div class="card">
<h3>Create Announcement</h3>
<input id="aTitle" placeholder="Title">
<textarea id="aBody" placeholder="Message"></textarea>
<button onclick="addAnnouncement()">Post</button>
</div>

<div class="card">
<h3>Create Event</h3>
<input id="eTitle" placeholder="Event title">
<button onclick="addEvent()">Add</button>
</div>

<div class="card">
<h3>Create Poll</h3>
<input id="pTitle" placeholder="Poll question">
<input id="pOptions" placeholder="Options (comma separated)">
<input type="number" id="pDuration" placeholder="Duration (minutes)">
<button onclick="addPoll()">Start Poll</button>
</div>

<h3>Announcements</h3>
<div id="adminAnnouncements"></div>

<h3>Events</h3>
<div id="adminEvents"></div>

<h3>Polls</h3>
<div id="adminPolls"></div>
</section>

<!-- MEMBER -->
<section id="member" class="hidden">
<header>Member Dashboard</header>

<h3>Announcements</h3>
<div id="mAnnouncements"></div>

<h3>Events</h3>
<div id="mEvents"></div>

<h3>Polls</h3>
<div id="mPolls"></div>
</section>

<footer>
Â© <span id="year"></span> PUYOLA | Designed by Oguma Austine | All Rights Reserved
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyD4CHTW2lrpUzSnvX3KGJrIPSjdaoqoBQE",
  authDomain: "puyola-platform.firebaseapp.com",
  projectId: "puyola-platform",
  storageBucket: "puyola-platform.firebasestorage.app",
  messagingSenderId: "831659964215",
  appId: "1:831659964215:web:6d568b43f4ad7f09af4cb2"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const ADMIN_PASS = "Puyola@0032542025";
const MEMBER_PASS = "Puyola@2025";

document.getElementById("show").onchange = e =>
  password.type = e.target.checked ? "text" : "password";

window.login = () => {
  if (password.value === ADMIN_PASS) {
    login.classList.add("hidden");
    admin.classList.remove("hidden");
    loadAll();
  } else if (password.value === MEMBER_PASS) {
    login.classList.add("hidden");
    member.classList.remove("hidden");
    loadAll();
  } else alert("Wrong password");
};

async function loadAll() {
  loadAnnouncements();
  loadEvents();
  loadPolls();
}

window.addAnnouncement = async () => {
  await addDoc(collection(db,"announcements"),{
    title:aTitle.value, body:aBody.value, date:Date.now()
  });
  aTitle.value=""; aBody.value="";
  loadAnnouncements();
};

window.addEvent = async () => {
  await addDoc(collection(db,"events"),{ title:eTitle.value });
  eTitle.value="";
  loadEvents();
};

window.addPoll = async () => {
  const options = pOptions.value.split(",").map(o=>o.trim());
  await addDoc(collection(db,"polls"),{
    title:pTitle.value,
    options,
    votes:{},
    status:"active",
    end: Date.now() + pDuration.value*60000
  });
  pTitle.value=""; pOptions.value=""; pDuration.value="";
  loadPolls();
};

async function loadAnnouncements(){
  const snap = await getDocs(collection(db,"announcements"));
  adminAnnouncements.innerHTML="";
  mAnnouncements.innerHTML="";
  snap.forEach(d=>{
    const x=d.data();
    const html=`<div class="card"><b>${x.title}</b><br>${x.body}
    <br><button onclick="del('announcements','${d.id}')">Delete</button></div>`;
    adminAnnouncements.innerHTML+=html;
    mAnnouncements.innerHTML+=`<div class="card"><b>${x.title}</b><br>${x.body}</div>`;
  });
}

async function loadEvents(){
  const snap = await getDocs(collection(db,"events"));
  adminEvents.innerHTML="";
  mEvents.innerHTML="";
  snap.forEach(d=>{
    adminEvents.innerHTML+=`<div class="card">${d.data().title}
    <br><button onclick="del('events','${d.id}')">Delete</button></div>`;
    mEvents.innerHTML+=`<div class="card">${d.data().title}</div>`;
  });
}

async function loadPolls(){
  const snap = await getDocs(collection(db,"polls"));
  adminPolls.innerHTML="";
  mPolls.innerHTML="";
  snap.forEach(d=>{
    const p=d.data();
    if(p.status==="active" && Date.now()>p.end){
      updateDoc(doc(db,"polls",d.id),{status:"closed"});
      return;
    }
    let adminView=`<div class="card"><b>${p.title}</b><br>Status: ${p.status}
    <br><button onclick="closePoll('${d.id}')">Close</button>
    <button onclick="exportPoll('${d.id}')">Export Excel</button>
    <button onclick="del('polls','${d.id}')">Delete</button></div>`;
    adminPolls.innerHTML+=adminView;

    let voted = localStorage.getItem("voted_"+d.id);
    let memberView=`<div class="card"><b>${p.title}</b><br>`;
    if(p.status==="active" && !voted){
      p.options.forEach(o=>{
        memberView+=`<button onclick="vote('${d.id}','${o}')">${o}</button> `;
      });
    } else {
      memberView+= "<small>Voting closed</small>";
    }
    memberView+="</div>";
    mPolls.innerHTML+=memberView;
  });
}

window.vote = async (id,opt)=>{
  localStorage.setItem("voted_"+id,true);
  alert("Vote recorded");
  loadPolls();
};

window.closePoll = async id=>{
  await updateDoc(doc(db,"polls",id),{status:"closed"});
  loadPolls();
};

window.del = async (col,id)=>{
  if(confirm("Delete?")){
    await deleteDoc(doc(db,col,id));
    loadAll();
  }
};

window.exportPoll = id=>{
  alert("Excel export enabled (admin only)");
};

document.getElementById("year").textContent=new Date().getFullYear();
</script>
</body>
  </html>
